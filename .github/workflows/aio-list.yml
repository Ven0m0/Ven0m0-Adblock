# This workflow lints, compiles, and cleans ad-block lists using a suite of tools.
name: Ad-Block List Pipeline

on:
  push:
    branches:
      - main
    paths:
      # Trigger on source list changes, not generated files.
      - '**.txt'
      - '!Filters/**'
      - 'hostlist-config.json'
      - 'ragibkl-config.json' # For the Python compiler
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Job 1: Lint, compile, and clean using AdGuard's Node.js-based toolchain.
  build-adguard-lists:
    name: Build with AdGuard Toolchain
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install AdGuard Tools
        run: npm i -g @adguard/hostlist-compiler @adguard/aglint @adguard/dead-domains-linter

      - name: Lint Source Lists with AGLint
        # This acts as a quality gate before compilation.
        run: aglint --all --fail-on-error

      - name: Compile All Hostfiles
        id: compile
        run: |
          set -e
          mkdir -p Filters
          declare -a compiler_args
          # Dynamically find all source .txt files for compilation.
          while IFS= read -r file; do
            compiler_args+=("-i" "$file")
          done < <(find . -type f -name "*.txt" ! -path "./Filters/*")
          
          if [[ ${#compiler_args[@]} -eq 0 ]]; then
            echo "No source hostfiles found."
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          else
            echo "Compiling..."
            hostlist-compiler "${compiler_args[@]}" -o Filters/Venom-Combined.txt --verbose
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Clean Compiled List with DeadDomainsLinter
        if: steps.compile.outputs.changes_detected == 'true'
        run: |
          # The linter modifies the file in-place.
          dead-domains-linter -i Filters/Venom-Combined.txt -o Filters/Venom-Combined.txt

      - name: Commit AdGuard List Changes
        if: steps.compile.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7.0.0
        with:
          commit_message: "chore(filters): Update and clean AdGuard compiled list"
          file_pattern: Filters/Venom-Combined.txt
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"

  # Job 2: Compile lists using the Python-based adblock-list-compiler.
  # This runs in parallel and is independent of the AdGuard job.
  build-ragibkl-list:
    name: Build with Ragibkl Compiler
    runs-on: ubuntu-latest
    # Only run this job if the specific config file for it exists.
    if: success() # && hashFiles('ragibkl-config.json') != ''
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Clone adblock-list-compiler
        run: git clone https://github.com/ragibkl/adblock-list-compiler.git adblock-compiler-repo

      - name: Compile with adblock-list-compiler
        id: compile
        run: |
          # This script assumes you have a 'ragibkl-config.json' in your root directory.
          python adblock-compiler-repo/main.py --config ragibkl-config.json --output Filters/Ragibkl-Combined.txt
          # Check if the output file was actually created and is not empty.
          if [[ -s "Filters/Ragibkl-Combined.txt" ]]; then
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Ragibkl List Changes
        if: steps.compile.outputs.changes_detected == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7.0.0
        with:
          commit_message: "chore(filters): Update ragibkl compiled list"
          file_pattern: Filters/Ragibkl-Combined.txt
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"

