name: Optimize UserScripts ðŸ¤–

on:
  # Run this workflow manually from the Actions tab
  workflow_dispatch:

  # Run this workflow on pushes to the main branch
  push:
    branches:
      - main # Or your default branch name
    paths:
      - 'userscripts/src/**/*.user.js'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Grant permission to write back to the repository

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Closure Compiler
        id: cache-compiler
        uses: actions/cache@v4
        with:
          path: ~/closure-compiler.jar
          key: ${{ runner.os }}-closure-compiler-latest

      - name: Download Closure Compiler
        if: steps.cache-compiler.outputs.cache-hit != 'true'
        run: |
          echo "Cache miss. Downloading new Closure Compiler..."
          curl -L -s https://dl.google.com/closure-compiler/compiler-latest.zip -o compiler.zip
          unzip compiler.zip compiler.jar
          mv compiler.jar ~/closure-compiler.jar
          rm compiler.zip
        shell: bash

      - name: Optimize Scripts
        run: |
          # Ensure the output directory exists
          mkdir -p userscripts/dist
          # Loop through each script in the source directory
          for file in userscripts/src/**/*.user.js; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              output_file="userscripts/dist/$filename"
              echo "Compiling: ${file} -> ${output_file}"
              java -jar ~/closure-compiler.jar \
                --js "$file" \
                --js_output_file "$output_file" \
                --compilation_level SIMPLE_OPTIMIZATIONS \
                --language_in ECMASCRIPT_NEXT \
                --language_out ECMASCRIPT_2020
            fi
          done
        shell: bash

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "ci: optimize userscripts"
          file_pattern: "userscripts/dist/*.user.js"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
