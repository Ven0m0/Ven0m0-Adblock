name: üõ°Ô∏è Build Filter Lists

on:
  push:
    branches:
      - main
    paths:
      - "lists/sources/**/*.txt"
      - "hostlist-config.json"
      - "configuration_popup_filter.json"
      - "ragibkl-config.json"
      - "build-lists.sh"
      - "mise.toml"
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Sources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: true
          experimental: true

      - name: Verify mise tools
        run: |
          mise doctor
          mise list

      - name: Run AGLint
        run: mise exec -- bunx aglint --fix
        continue-on-error: true

      - name: Commit lint fixes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "style: lint and fix filter lists"
          file_pattern: "lists/sources/**/*.txt"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"

  build-adguard:
    name: Build AdGuard Lists
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: true
          experimental: true

      - name: Compile AdGuard lists
        id: compile
        run: |
          set -e
          mkdir -p Filters lists/releases

          if [[ -f hostlist-config.json ]]; then
            printf 'Compiling with config...\n'
            mise exec -- bunx hostlist-compiler -c hostlist-config.json -o Filters/filter.txt
          fi

          declare -a compiler_args=()
          while IFS= read -r file; do
            compiler_args+=("-i" "$file")
          done < <(find lists/sources -type f -name "*.txt" 2>/dev/null || true)

          if (( ${#compiler_args[@]} > 0 )); then
            printf 'Compiling combined list...\n'
            mise exec -- bunx hostlist-compiler "${compiler_args[@]}" -o Filters/Venom-Combined.txt --verbose
            printf 'has_changes=true\n' >> "$GITHUB_OUTPUT"
          else
            printf 'No source files found\n'
            printf 'has_changes=false\n' >> "$GITHUB_OUTPUT"
          fi

      - name: Clean with DeadDomainsLinter
        if: steps.compile.outputs.has_changes == 'true'
        run: |
          for file in Filters/*.txt; do
            [[ -f $file ]] || continue
            printf 'Cleaning: %s\n' "$file"
            mise exec -- bunx dead-domains-linter -i "$file" -o "$file" || printf 'Failed to clean %s\n' "$file"
          done

      - name: Upload artifacts
        if: steps.compile.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: adguard-filters
          path: Filters/*.txt
          retention-days: 30

  build-ragibkl:
    name: Build Ragibkl Lists
    runs-on: ubuntu-latest
    needs: lint
    if: hashFiles('ragibkl-config.json') != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: true
          experimental: true

      - name: Clone adblock-list-compiler
        run: git clone --depth=1 https://github.com/ragibkl/adblock-list-compiler.git compiler

      - name: Install Python dependencies
        run: |
          cd compiler
          mise exec -- python -m pip install -r requirements.txt

      - name: Compile lists
        id: compile
        run: |
          mkdir -p Filters
          mise exec -- python compiler/main.py \
            --config ragibkl-config.json \
            --output Filters/Ragibkl-Combined.txt

          if [[ -s Filters/Ragibkl-Combined.txt ]]; then
            printf 'has_changes=true\n' >> "$GITHUB_OUTPUT"
          else
            printf 'has_changes=false\n' >> "$GITHUB_OUTPUT"
          fi

      - name: Upload artifacts
        if: steps.compile.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: ragibkl-filters
          path: Filters/Ragibkl-Combined.txt
          retention-days: 30

  build-custom:
    name: Build Custom Lists
    runs-on: ubuntu-latest
    needs: lint
    if: hashFiles('build-lists.sh') != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: true
          experimental: true

      - name: Run build script
        run: |
          chmod +x build-lists.sh
          mise exec -- ./build-lists.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: custom-filters
          path: lists/releases/*.txt
          retention-days: 30

  commit:
    name: Commit Changes
    runs-on: ubuntu-latest
    needs: [build-adguard, build-ragibkl, build-custom]
    if: |
      always() &&
      (needs.build-adguard.result == 'success' ||
       needs.build-ragibkl.result == 'success' ||
       needs.build-custom.result == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Download AdGuard artifacts
        if: needs.build-adguard.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: adguard-filters
          path: Filters/
        continue-on-error: true

      - name: Download Ragibkl artifacts
        if: needs.build-ragibkl.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: ragibkl-filters
          path: Filters/
        continue-on-error: true

      - name: Download custom artifacts
        if: needs.build-custom.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: custom-filters
          path: lists/releases/
        continue-on-error: true

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "ci: build and update filter lists"
          file_pattern: "Filters/*.txt lists/releases/*.txt"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          skip_dirty_check: false

  convert:
    name: Convert Lists
    runs-on: ubuntu-latest
    needs: commit
    if: github.event_name == 'schedule' && hashFiles('convert.sh') != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: true

      - name: Run conversion
        run: |
          chmod +x convert.sh
          mise exec -- bash convert.sh
        env:
          repository: ${{ github.repository }}

      - name: Push to release branch
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: release
          commit_message: "ci: update converted lists"
          file_pattern: "release/*"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          create_branch: true
          push_options: "--force"

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [commit, convert]
    if: always() && github.event_name == 'schedule'
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3
